<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 다른 mapper와 중복되지 않도록 네임스페이스 기재 -->
<!-- mapper - mybatis, sqlMap - ibatis -->
<mapper namespace="admin">

	<sql id="searchSql">
  		<choose>
  			<when test="searchType == 'MEMBER_CODE'">
  				AND MEMBER_CODE LIKE '%'||#{searchTxt}||'%'
  			</when>
  			<when test="searchType == 'mem_id'">
				AND mem_id LIKE '%'||#{searchTxt}||'%'
			</when>
  			<when test="searchType == 'mem_name'">
  				AND mem_id LIKE '%'||#{searchTxt}||'%'
  			</when>
  		</choose>
  		<if test="searchType2 != 'select' and searchType2 != null and searchType2 != ''">
  				AND SIGN_STATUS = #{searchType2}
  		</if>
  		<if test="startDate != null and startDate != ''">
  				AND TO_CHAR(REG_DATE, 'yyyy-MM-dd') BETWEEN #{startDate} AND #{endDate}
  		</if>
  	</sql>
	
	<!-- 대쉬보드 회원 목록 불러오기 -->
	<select id="memberList" resultType="com.shopping.dto.MemberDTO">
		SELECT
			MEM_ID,
			MEM_PW,
			MEM_NAME,
			EMAIL,
			PHONE,
			ADDR1,
			ADDR2,
			POST,
			USEYN,
			CODE,
			JOIN_DATE,
			DEL_DATE
		FROM MEMBER 
		WHERE CODE = '2' LIMIT 17	<!-- code1 : 관리자 // code2 : 일반회원 -->
	</select>
	
	<!-- 모든 회원 목록 불러오기 -->
	 <select id="allMemberList" resultType="com.shopping.dto.MemberDTO">
		SELECT
			MEM_ID,
			MEM_PW, 
			MEM_NAME, 
			EMAIL, 
			PHONE,
			ADDR1,
			ADDR2,
			POST, 
			USEYN, 
			JOIN_DATE, 
			DEL_DATE,
			CODE,
			CASE
				WHEN CODE='1' THEN '관리자'
				WHEN CODE='2' THEN '일반회원'
				WHEN CODE='3' THEN '정지회원'
			END AS 'MEMBER_CODE'
		FROM MEMBER
		ORDER BY JOIN_DATE DESC
	</select>
	
	<!-- 회원 정보 상세 보기 -->
	<select id="memberRead" resultType="com.shopping.dto.MemberDTO">
		SELECT
			MEM_ID,
			MEM_PW, 
			MEM_NAME, 
			EMAIL, 
			PHONE, 
			ADDR1,
			ADDR2,
			POST,
			USEYN, 
			JOIN_DATE, 
			DEL_DATE
		FROM MEMBER
		WHERE MEM_ID = #{mem_id}
	</select>
	
	<!-- 회원 정보 수정 -->
	<update id="memberUpdate">
		UPDATE MEMBER SET
			MEM_PW = #{mem_pw},
			MEM_NAME = #{mem_name},
			EMAIL = #{email},
			PHONE = #{PHONE},
			ADDR1 = #{addr1},
			ADDR2 = #{addr2},
			POST = #{post} 
		WHERE MEM_ID = #{mem_id}
	</update>
	
	<!--  회원 탈퇴 -->
	<update id="memberDelete">
		UPDATE MEMBER SET 
			USEYN = 'N',
			DEL_DATE = NOW()
		WHERE MEM_ID = #{mem_id}
	</update>
	
	<!-- 주문 목록 조회 -->
	<select id="allOrderList" resultType="com.shopping.dto.OrderDTO">
	    SELECT 
		    ORDER_NO,
		    MEM_ID,
		    MEM_NAME,
		    PHONE,
		    EMAIL,
		    PROD_NO,
		    PROD_NAME,
		    PROD_IMAGE,
		    PRICE,
		    QUANTITY,
		    SIZE,
		    DELIVERYFEE,
		    POST,
		    ADDR1,
		    ADDR2,
		    ORDER_DATE,
		    CASE
		        WHEN ORDER_STATE = 'orderCompleted' THEN '주문 완료'
		        ELSE ORDER_STATE
		    END AS ORDER_STATE,
		    CASE
		        WHEN PAYMENT_STATE = 'depositCompleted' THEN '입금 완료'
		        ELSE PAYMENT_STATE
		    END AS PAYMENT_STATE,
		    CASE
		        WHEN PAYMENT_METHOD = 'bankTransfer' THEN '무통장 입금'
		        ELSE PAYMENT_METHOD
		    END AS PAYMENT_METHOD
		FROM TRANSACTION
		ORDER BY ORDER_DATE DESC
	</select>
	
	<!-- 사용자들 각각의 (주문 * 수량) 금액 조회 -->
	<select id="userTotalPrice" resultType="map">
		SELECT 
		    T.MEM_ID,
		    SUM(T.PRICE * T.QUANTITY) AS TOTAL_PRICE
		FROM TRANSACTION T
			LEFT JOIN PAYMENT P ON T.ORDER_NO = P.ORDER_NO
		GROUP BY T.MEM_ID;
	</select>
</mapper> 