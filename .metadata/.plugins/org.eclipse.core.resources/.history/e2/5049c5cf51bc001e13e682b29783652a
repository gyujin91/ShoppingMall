package com.shopping.controller;

import java.util.HashMap;
import java.util.Map;

import javax.servlet.http.HttpSession;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import com.shopping.dto.CartDTO;
import com.shopping.dto.MemberDTO;
import com.shopping.service.CartService;


@Controller
@RequestMapping("/cart/*")
public class CartController {
	
	@Autowired
	CartService cartService;
	
	private static final Logger logger = LoggerFactory.getLogger(CartController.class);
	
	// 장바구니 페이지 이동
	@RequestMapping("cart.do")
	public String cart(HttpSession session, Model model, @RequestParam Map<String, Object> map) throws Exception {
		// 세션으로 로그인 여부 체크
		map.put("loginMap", session.getAttribute("loginMap"));
		if(map.get("loginMap") != null) {
			// 로그인 상태
			System.out.println("로그인한 상태.. 사용자 아이디 : " + map);
			return "cart/cart";
		} else {
			// 로그인 하지 않은 상태 
			System.out.println("로그인하지 않은 상태..");
			// 로그인 페이지로 리다이렉트
			model.addAttribute("loginChk", "chkFail");
			return "cart/cart";
		}
	}
	
//	@RequestMapping("addToCart.do")
//	public String addToCart(Model model, CartDTO dto, HttpSession session, @RequestParam Map<String, Object> map) throws Exception {
//		String mem_id = (String) session.getAttribute("loginMap");
//			
//		if(mem_id != null) {
//			// 로그인된 사용자인 경우
//			mem_id.toString();
//			System.out.println("로그인한 상태.. 사용자 아이디 : " + mem_id);
//			cartService.addToCart(dto);
//			return "redirect:cart/cart.do";
//		} else {
//			// 로그인 하지 않은 경우
//			System.out.println("로그인하지 않은 상태..");
//			return "redirect:/member/loginForm.do";
//		}
//	}
	
	@RequestMapping("addToCart.do")
	public String addToCart(Model model, CartDTO dto, HttpSession session, @RequestParam Map<String, Object> map) throws Exception {
	   Map<String, Object> loginMap = (Map<String, Object>) session.getAttribute("loginMap");
	   
	   if(loginMap != null) {
		   String mem_id = (String) loginMap.get("mem_id");
		   
		   System.out.println("로그인한 상태.. 사용자 아이디 : " + mem_id);
		   dto.setMem_id(mem_id);
		   cartService.addToCart(dto);
		   return "direct:/cart/cart.do";
	   } else {
		   System.out.println("로그인 x");
		   return "redirect:/member/loginForm.do";
	   }
	}

	
	
}
